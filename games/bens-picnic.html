<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ben's Picnic — Endue Learning</title>

  <link rel="stylesheet" href="../assets/css/header.css">
  <link rel="stylesheet" href="../assets/css/style.css">

  <script src="../assets/js/header.js" defer></script>
  <script src="../assets/js/footer.js" defer></script>

  <style>
    .game-wrapper { max-width:1100px; margin:18px auto; padding:12px; }
    .iframe-frame { position:relative; width:100%; padding-top:56.25%; border-radius:10px; overflow:hidden; box-shadow:0 10px 30px rgba(12,45,80,0.08); background:#000; }
    .iframe-frame iframe { position:absolute; top:0; left:0; width:100%; height:100%; border:0; }

    .game-actions { display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .hint { color:#556; font-size:0.95rem; }
    .btn { background:#2b9cff; color:#fff; padding:10px 14px; border-radius:10px; text-decoration:none; font-weight:700; display:inline-block; }

    .mobile-ctrls { position: fixed; left: 12px; bottom: 18px; z-index: 2200; display: flex; gap: 10px; align-items: center; pointer-events: none; }
    .mobile-ctrls .ctrl-btn { pointer-events: auto; width: 60px; height: 60px; border-radius: 12px; background: rgba(43,156,255,0.95); color: #fff; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; box-shadow:0 8px 18px rgba(11,53,85,0.18); user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0); }
    .mobile-ctrls .ctrl-btn.small { width:46px; height:46px; font-size:18px; border-radius:10px; }
    .mobile-ctrls .ctrl-btn:active { transform: translateY(2px) scale(.98); }

    :fullscreen .mobile-ctrls, :-webkit-full-screen .mobile-ctrls, .mobile-ctrls.fullscreen-visible { display:flex !important; }
    @media(min-width:880px) { .mobile-ctrls { display: none !important; } }

    /* debug overlay (hidden by default) */
    #vc-debug { position: fixed; right: 12px; bottom: 18px; z-index:2400; background:rgba(0,0,0,0.7); color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; display:none; }
  </style>
</head>
<body>
  <div id="header"></div>

  <script>
  // Ensure header Home link points to site root when page is in a subfolder.
  (function fixHomeLink(){
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const header = document.querySelector('header.main-header') || document.getElementById('header');
        if (!header) return;
        const homeLinks = document.querySelectorAll('a[href="index.html"], a[href="./index.html"], a[href="./"]');
        homeLinks.forEach(a => {
          a.setAttribute('href', '/index.html'); // root-aware absolute link
        });
        // Also fix logo link if present
        const logoLink = document.querySelector('.logo-link');
        if (logoLink) logoLink.setAttribute('href', '/index.html');
      } catch(e) { /* ignore */ }
    });
  })();
</script>

  <main class="container game-wrapper">
    <h1>Ben's Picnic</h1>
    <p class="small">Use arrow keys on desktop. On mobile, use the buttons below. Short tap = single step; hold = continuous move.</p>

    <div class="iframe-frame" id="gameFrameWrap" aria-live="polite">
      <iframe id="gameIframe" src="ben-picnic-full.html" title="Ben's Picnic" allow="autoplay; fullscreen; encrypted-media" loading="lazy" style="background:#000;"></iframe>
    </div>

    <div class="game-actions">
      <a class="btn" id="openFull" href="ben-picnic-full.html" target="_blank" rel="noopener">Open full page</a>
      <span class="hint">If the game doesn't respond on mobile, tap inside the game area once to enable audio and focus.</span>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3>How to play</h3>
      <p>Left / Right to move, Up to jump. On mobile use the buttons below.</p>
    </div>
  </main>

  <div id="footer"></div>

  <div class="mobile-ctrls" id="mobileCtrls" aria-hidden="false" role="group" aria-label="Mobile game controls">
    <button class="ctrl-btn" data-key="ArrowLeft" id="btnLeft" aria-label="Left">◀</button>
    <button class="ctrl-btn" data-key="ArrowRight" id="btnRight" aria-label="Right">▶</button>
    <button class="ctrl-btn small" data-key="ArrowUp" id="btnUp" aria-label="Up">▲</button>
    <button class="ctrl-btn small" data-key="ArrowDown" id="btnDown" aria-label="Down">▼</button>
    <button class="ctrl-btn small" data-key=" " id="btnSpace" aria-label="Action">␣</button>
  </div>

  <div id="vc-debug" aria-hidden="true"></div>

  <!-- SCRIPT: audio unlock + fullscreen visibility -->
  <script>
  (function(){
    const iframe = document.getElementById('gameIframe');
    const wrap = document.getElementById('gameFrameWrap');
    const mobileCtrls = document.getElementById('mobileCtrls');

    function tryUnlockAudio() {
      try { iframe.contentWindow.postMessage({ type: 'user-gesture' }, window.location.origin); } catch(e){}
      try {
        const doc = iframe.contentWindow.document;
        doc.querySelectorAll('audio,video').forEach(m => { try { m.muted = false; m.volume = 1; m.play().catch(()=>{}); } catch(e){} });
        const Howler = iframe.contentWindow.Howler || iframe.contentWindow.howler;
        if (Howler && Howler.ctx && Howler.ctx.state === 'suspended') Howler.ctx.resume().catch(()=>{});
        const ctx = iframe.contentWindow.__scratchAudioContext || iframe.contentWindow.audioContext || (Howler && Howler.ctx);
        if (ctx && ctx.state === 'suspended') ctx.resume().catch(()=>{});
      } catch(e){}
      wrap.removeEventListener('pointerdown', tryUnlockAudio);
      wrap.removeEventListener('click', tryUnlockAudio);
    }
    wrap.addEventListener('pointerdown', tryUnlockAudio, { once: true });
    wrap.addEventListener('click', tryUnlockAudio, { once: true });

    function updateFullscreenVisibility(){
      const fs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement;
      if (fs) mobileCtrls.classList.add('fullscreen-visible'); else mobileCtrls.classList.remove('fullscreen-visible');
    }
    document.addEventListener('fullscreenchange', updateFullscreenVisibility);
    document.addEventListener('webkitfullscreenchange', updateFullscreenVisibility);
    document.addEventListener('mozfullscreenchange', updateFullscreenVisibility);

    // extra: detect if iframe became fullscreen via attribute check every 300ms (fallback)
    setInterval(updateFullscreenVisibility, 300);
  })();
  </script>

  <!-- SCRIPT: improved mobile virtual controls (tap vs hold) -->
  <script>
  (function(){
    const iframe = document.getElementById('gameIframe');
    const controls = document.querySelectorAll('.mobile-ctrls .ctrl-btn');
    const debug = document.getElementById('vc-debug');
    let debugOn = false; // set true to show debug overlay

    function debugLog(s){ if(!debugOn) return; debug.style.display='block'; debug.textContent = s; }

    if(!iframe) return;

    function sendKeyToIframe(key, type='keydown'){
      try {
        const win = iframe.contentWindow;
        if(!win) return;
        const ev = new win.KeyboardEvent(type, { key: key === ' ' ? ' ' : key, code: key, bubbles: true, cancelable: true });
        const target = win.document.activeElement || win.document.body || win.document;
        target.dispatchEvent(ev);
        win.dispatchEvent(ev);
        debugLog(`${type} → ${key}`);
      } catch (err) {
        try { iframe.contentWindow.postMessage(JSON.stringify({ type:'virtual-key', key, action:type }), '*'); debugLog(`postMessage ${type}→${key}`); } catch(e){}
      }
    }

    controls.forEach(btn => {
      const key = btn.getAttribute('data-key');
      let holdInterval = null;
      let tapTimeout = null;
      const HOLD_DELAY = 220;   // ms before treating as hold
      const REPEAT_INTERVAL = 140; // ms repeat while holding

      function startPress(e){
        e.preventDefault();
        sendKeyToIframe(key, 'keydown');

        // if released before HOLD_DELAY => treat as tap; otherwise start repeating
        tapTimeout = setTimeout(()=> {
          tapTimeout = null;
          holdInterval = setInterval(()=> sendKeyToIframe(key, 'keydown'), REPEAT_INTERVAL);
        }, HOLD_DELAY);
      }

      function endPress(e){
        e.preventDefault();
        if (tapTimeout) {
          clearTimeout(tapTimeout);
          tapTimeout = null;
          // short tap: send a quick keyup shortly so the game registers a single step
          setTimeout(()=> sendKeyToIframe(key, 'keyup'), 60);
        } else {
          if (holdInterval) { clearInterval(holdInterval); holdInterval = null; }
          sendKeyToIframe(key, 'keyup');
        }
      }

      btn.addEventListener('pointerdown', startPress);
      btn.addEventListener('pointerup', endPress);
      btn.addEventListener('pointerleave', endPress);
      btn.addEventListener('touchstart', startPress, { passive:false });
      btn.addEventListener('touchend', endPress);
      btn.addEventListener('mousedown', startPress);
      btn.addEventListener('mouseup', endPress);
      btn.addEventListener('touchmove', (ev)=> ev.preventDefault(), { passive:false });
    });

    function updateVisibility(){
      const show = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
      const el = document.getElementById('mobileCtrls');
      if (el) el.style.display = show ? 'flex' : 'none';
    }
    updateVisibility();
    window.addEventListener('resize', updateVisibility);

  })();
  </script>
</body>
</html>
